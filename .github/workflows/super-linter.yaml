name: Lint Code Base

on:
  push:
  pull_request:
    branches: [master, release, develop]

jobs:
  build:
    name: Lint Code Base
    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: read
      statuses: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '16'

      - name: Lint Code Base
        uses: github/super-linter@v5
        env:
          VALIDATE_ALL_CODEBASE: true
          DEFAULT_BRANCH: master
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPORT_OUTPUT_FOLDER: reports
          OUTPUT_FORMAT: sarif
          OUTPUT_DETAILS: simplified  # Generate SARIF output with simplified details

      - name: Ensure SARIF Report Exists
        run: |
          if [ ! -f reports/super-linter.sarif ]; then
            echo "SARIF report not found! Creating dummy report..."
            mkdir -p reports
            echo '{
              "$schema": "https://schemastore.azurewebsites.net/schemas/json/sarif-2.1.0.json",
              "version": "2.1.0",
              "runs": [
                {
                  "tool": {
                    "driver": {
                      "name": "Super-Linter",
                      "informationUri": "https://github.com/github/super-linter",
                      "rules": []
                    }
                  },
                  "results": []
                }
              ]
            }' > reports/super-linter.sarif
          fi

      - name: Install Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install DefectDojo API Client
        run: pip install defectdojo_api

      - name: Upload to DefectDojo
        run: python .github/workflows/upload_to_defectdojo.py
